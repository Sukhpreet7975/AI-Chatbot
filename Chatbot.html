<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Generator ChatBot - Professional</title>
    <!-- Favicon for the page -->
    <link rel="icon" type="image/png" href="robot.png">

    <!-- External CSS Libraries -->
    <!-- Bootstrap 5 for layout and components -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.0/css/bootstrap.min.css">
    <!-- Bootstrap Icons for iconography -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Marked.js for rendering Markdown content in the chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- CSS Custom Properties (Variables) for Theming --- */
        :root {
            /* Color Palette */
            --primary-color: #17a2b8; /* Teal */
            --primary-hover: #138496; /* Darker Teal */
            --secondary-color: #494e54; /* Mid Grey */
            --light-bg: #f8f9fa; /* Very Light Grey */
            --white: #ffffff;
            --dark-text: #343a40; /* Dark Grey/Black */
            --muted-text: #6c757d; /* Mid Grey */
            --border-color: #dee2e6; /* Light Grey Border */
            --user-msg-bg: #e2f3f5; /* Light Teal */
            --bot-msg-bg: var(--white);
            --user-msg-label: var(--primary-hover);
            --bot-msg-label: var(--primary-color);
            --link-color: var(--primary-color);
            --typing-dot-color: var(--secondary-color);
            --accordion-header-bg: var(--white);
            --accordion-active-bg: var(--primary-color);
            --accordion-active-color: var(--white);
            --blockquote-border: var(--primary-color);
            --chat-body-bg: #f1f5f9; /* Slightly different chat body background */

            /* Shadows & Borders */
            --shadow-sm: 0 .125rem .25rem rgba(0, 0, 0, .075);
            --shadow-md: 0 .5rem 1rem rgba(0, 0, 0, .15);
            --border-radius-sm: 0.25rem;
            --border-radius-md: 0.5rem;
            --border-radius-lg: 0.8rem;
        }

        /* --- General Body Styling --- */
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            color: var(--dark-text);
            background-color: var(--white);
            line-height: 1.6;
        }

        /* --- Hero Section --- */
        .hero {
            background-color: var(--light-bg);
            color: var(--dark-text);
            text-align: center;
            padding: 100px 20px;
        }
        .hero h1 {
            font-weight: 600;
            margin-bottom: 0.75rem;
        }
        .hero p.lead {
             color: var(--muted-text);
             font-size: 1.15rem;
        }
        #logo {
            width: 90px;
            height: auto;
            margin-bottom: 20px;
            border-radius: var(--border-radius-sm);
        }

        /* --- General Section Styling --- */
        section {
             padding-top: 60px;
             padding-bottom: 60px;
        }
        /* Background color for alternating sections */
        .section-bg {
            background-color: var(--light-bg);
        }
        /* Centered section title */
        h2.section-title {
            text-align: center;
            margin-bottom: 40px;
            font-weight: 600;
            color: var(--dark-text);
        }

        /* --- Feature & How-It-Works Cards --- */
        .feature-card, .how-card {
             border: 1px solid var(--border-color);
             padding: 25px;
             border-radius: var(--border-radius-md);
             background-color: var(--white);
             box-shadow: var(--shadow-sm);
             transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
             height: 100%; /* Ensure cards in a row have same height */
             display: flex;
             flex-direction: column;
             align-items: center; /* Center content */
             text-align: center;
        }
        /* Hover effect for cards */
        .feature-card:hover, .how-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }
        /* Card headings */
        .feature-card h4, .how-card h5 {
             color: var(--primary-color);
             font-weight: 600;
             margin-bottom: 10px;
             font-size: 1.2rem;
        }
         /* Card paragraph text */
         .feature-card p, .how-card p {
              color: var(--muted-text);
              font-size: 0.95rem;
         }

        /* --- Contact Section --- */
        .contact-section {
            text-align: center;
        }
        .contact-section h1 b {
             font-weight: 600;
        }
         .contact-section h2 {
             font-weight: 600;
         }
        /* Specific styling for developer names paragraph (as requested in original) */
        #para {
            text-decoration: underline;
            color: #dc3545; /* Using red as originally specified, consider changing to a theme color */
            font-weight: bold;
        }

        /* --- Chatbot Toggle Button --- */
        .chat-toggle-btn {
            position: fixed; /* Keeps button in viewport */
            bottom: 25px;
            right: 25px;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 50%; /* Makes it circular */
            width: 65px;
            height: 65px;
            font-size: 28px; /* Icon size */
            cursor: pointer;
            box-shadow: var(--shadow-md);
            z-index: 1050; /* Ensures button is above most other content */
            display: flex;
            justify-content: center;
            align-items: center;

            /* Styles for smooth fade transition when chat opens/closes */
            opacity: 1;
            visibility: visible;
            transition: background-color 0.3s ease, transform 0.2s ease, opacity 0.3s ease, visibility 0.3s ease;
        }
        /* Hover effect for toggle button */
        .chat-toggle-btn:hover {
             background: var(--primary-hover);
             transform: scale(1.05);
        }
        /* Ensure icon inside button is centered */
        .chat-toggle-btn svg, .chat-toggle-btn i {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Chatbot Container --- */
        .chat-container {
            position: fixed; /* Keeps chat window in viewport */
            bottom: 30px;
            right: 30px;
            /* --- UPDATED DIMENSIONS (Larger Window) --- */
            width: 950px; /* Increased width */
            height: 750px; /* Increased height */
            max-height: calc(100vh - 60px); /* Prevents overflow on smaller screens */
            /* --- END UPDATED DIMENSIONS --- */
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
            display: none; /* Initially hidden */
            flex-direction: column; /* Stacks header, body, footer vertically */
            z-index: 1040; /* Below toggle button but above most content */
            border: 1px solid var(--border-color);
            overflow: hidden; /* Clips content overflowing the rounded corners */
        }

        /* --- Chatbot Header --- */
        .chat-header {
            display: flex;
            justify-content: space-between; /* Title left, close button right */
            align-items: center;
            font-weight: 600;
            padding: 15px 20px;
            background: var(--primary-color);
            color: var(--white);
            cursor: grab; /* Indicates draggable */
            flex-shrink: 0; /* Prevents header from shrinking */
        }
        /* Cursor change during drag */
        .chat-header:active {
             cursor: grabbing;
        }
        /* Close button ('✕') styling */
        .chat-close {
            cursor: pointer;
            font-size: 24px;
            font-weight: normal;
            padding: 0 5px;
            line-height: 1;
            color: rgba(255, 255, 255, 0.8); /* Slightly transparent */
            transition: color 0.2s ease;
        }
        .chat-close:hover {
             color: var(--white); /* Opaque on hover */
        }

        /* --- Chatbot Body (Message Area) --- */
        .chat-body {
            flex-grow: 1; /* Takes up available vertical space */
            overflow-y: auto; /* Enables scrolling for messages */
            padding: 20px;
            background: var(--chat-body-bg);
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
        }

        /* --- General Chat Message Styling --- */
        .chat-body p {
            margin-bottom: 12px;
            line-height: 1.5;
            max-width: 100%; /* Prevents overflow */
            word-wrap: break-word; /* Breaks long words */
            padding: 12px 18px; /* Base padding */
            border-radius: var(--border-radius-md);
        }
         /* Styling for sender labels (e.g., "You:", "Bot:") */
         .chat-body p b {
            display: block; /* Puts label on its own line */
            margin-bottom: 4px;
            font-size: 0.85em;
            font-weight: 600;
            opacity: 0.9;
         }
         /* Remove bottom margin from the very last message */
         .chat-body p:last-child {
             margin-bottom: 0;
         }

         /* --- User Message Specific Styling --- */
         .you-message {
             text-align: left;
             margin-left: 45px; /* Indent user message */
             margin-right: 0;
             background-color: var(--user-msg-bg);
             border-radius: var(--border-radius-md) var(--border-radius-md) 0 var(--border-radius-md);
             /* User messages don't get buttons, so standard padding is fine */
             padding-right: 18px; /* Default padding */
         }
         .you-message b {
            color: var(--user-msg-label); /* Specific color for "You:" label */
         }

         /* --- Bot Message Specific Styling (Corrected for Buttons) --- */
         .bot-message {
             text-align: left;
             margin-right: 45px; /* Indent bot message */
             margin-left: 0;
             background-color: var(--bot-msg-bg);
             border-radius: var(--border-radius-md) var(--border-radius-md) var(--border-radius-md) 0;
             border: 1px solid var(--border-color);
             box-shadow: var(--shadow-sm);
             position: relative; /* Needed for absolute positioning of buttons */
             /* --- CORRECTED PADDING --- */
             /* Increase padding significantly to fit both buttons comfortably */
             padding-right: 110px !important; /* Use !important to override general 'p' padding if needed */
             /* --- END CORRECTED PADDING --- */
         }
          .bot-message b {
             color: var(--bot-msg-label); /* Specific color for "Bot:" label */
         }

         /* --- Markdown Content Styling (within Bot Messages) --- */
         /* Target the span wrapping the markdown content */
         .bot-message > span {
             display: block;
         }
         /* Reset parent paragraph styles and apply base styles for markdown elements */
         .bot-message span p,
         .bot-message span ul,
         .bot-message span ol,
         .bot-message span pre,
         .bot-message span blockquote,
         .bot-message span table {
             margin-bottom: 10px !important; /* Tighter spacing within markdown */
             line-height: 1.5;
             background: none;
             padding: 0;
             border: none;
             box-shadow: none;
             color: inherit; /* Inherit text color from parent */
             font-size: inherit; /* Inherit font size */
             text-align: left; /* Ensure left alignment */
         }
         /* Specific Markdown element styling */
         .bot-message span ul, .bot-message span ol { padding-left: 25px; margin-bottom: 10px; }
         .bot-message span li { margin-bottom: 6px; }
         .bot-message span blockquote { border-left: 3px solid var(--blockquote-border); padding-left: 15px; margin-left: 0; color: var(--muted-text); font-style: italic; background: none; }
         .bot-message span code:not(pre code) { background-color: #e9ecef; padding: 2px 5px; border-radius: var(--border-radius-sm); font-size: 0.9em; font-family: monospace; color: #c7254e; }
         .bot-message span pre { background-color: #f1f1f1; color: var(--dark-text); padding: 12px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); overflow-x: auto; font-family: monospace; font-size: 0.85em; line-height: 1.4; }
         .bot-message span pre code { padding: 0; background: none; color: inherit; border: none; font-size: inherit; }
         .bot-message span table { border-collapse: collapse; width: 100%; margin-bottom: 12px; font-size: 0.9em; }
         .bot-message span th, .bot-message span td { border: 1px solid var(--border-color); padding: 6px 10px; text-align: left; }
         .bot-message span th { background-color: var(--light-bg); font-weight: 600; }


        /* --- EXPORT BUTTON STYLING (Corrected Position) --- */
        .export-invoice-btn {
            position: absolute;
            top: 10px;
             /* --- CORRECTED POSITION --- */
             right: 75px; /* Moved further left */
             /* --- END CORRECTED POSITION --- */
            padding: 3px 8px;
            font-size: 0.8em;
            background-color: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease, background-color 0.2s ease;
            z-index: 1;
        }
        .export-invoice-btn:hover {
            opacity: 1;
            background-color: var(--primary-hover);
        }
        .export-invoice-btn i {
            margin-right: 4px;
        }
        /* --- END EXPORT BUTTON STYLING --- */


        /* --- PRINT BUTTON STYLING (Corrected Position) --- */
        .print-invoice-btn {
            position: absolute;
            top: 10px;
             /* --- CORRECTED POSITION --- */
             right: 10px; /* Keep at the edge */
             /* --- END CORRECTED POSITION --- */
            padding: 3px 8px;
            font-size: 0.8em;
            background-color: var(--secondary-color);
            color: var(--white);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s ease, background-color 0.2s ease;
            z-index: 1;
        }
        .print-invoice-btn:hover {
            opacity: 1;
            background-color: #343a40;
        }
        .print-invoice-btn i {
            margin-right: 4px;
        }
        /* --- END PRINT BUTTON STYLING --- */


        /* --- Chatbot Footer (Input Area) --- */
        .chat-footer {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            background: var(--white);
            flex-shrink: 0; /* Prevents footer from shrinking */
        }
        /* Text input field */
        .chat-footer input[type="text"] {
            flex-grow: 1; /* Takes up available horizontal space */
            margin-right: 10px;
            border-radius: var(--border-radius-md);
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            font-size: 0.95rem;
            background-color: var(--white);
        }
         /* Focus style for input field */
         .chat-footer input[type="text"]:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25); /* Teal focus ring */
             outline: none;
         }
        /* Send button */
        .chat-footer .btn-send {
             flex-shrink: 0; /* Prevents button from shrinking */
             border-radius: var(--border-radius-md);
             width: 42px;
             height: 42px;
             padding: 0;
             display: flex;
             justify-content: center;
             align-items: center;
             background-color: var(--primary-color);
             border: none;
             transition: background-color 0.2s ease;
        }
        .chat-footer .btn-send:hover {
             background-color: var(--primary-hover);
        }
        /* Icon inside send button */
        .chat-footer .btn-send svg, .chat-footer .btn-send i { width: 18px; height: 18px; color: var(--white); }

        /* --- Typing Indicator Animation --- */
        /* Keyframes for the dot animation */
        @keyframes bubbleAnimation {
            0%, 100% { transform: translateY(0); opacity: 0.6; }
            50% { transform: translateY(-3px); opacity: 1; }
        }
        /* Styling for the animated dots */
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: var(--typing-dot-color);
            border-radius: 50%;
            margin: 0 2px;
            animation: bubbleAnimation 1.2s infinite ease-in-out;
        }
        /* Stagger the animation start times for the dots */
        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.15s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.3s; }
        /* Container for the typing indicator, styled like a bot message */
        #typingIndicator {
            color: var(--muted-text);
            font-style: italic;
            margin-right: 45px; /* Indent like bot message */
            padding: 12px 18px; /* Match message padding */
            background-color: var(--bot-msg-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
             /* "Tail" effect */
            border-radius: var(--border-radius-md) var(--border-radius-md) var(--border-radius-md) 0;
            /* Override button padding for typing indicator */
            padding-right: 18px !important;
        }
        /* Styling for the "Bot:" label within the indicator */
        #typingIndicator b {
            font-style: normal;
            margin-right: 5px;
            color: var(--bot-msg-label);
            font-size: 0.85em;
            font-weight: 600;
            opacity: 0.9;
        }

        /* --- FAQ Accordion Styling (Bootstrap Override/Customization) --- */
        .accordion-item {
             margin-bottom: 10px;
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius-sm);
             overflow: hidden; /* Ensures border-radius applies correctly */
        }
         /* Remove default Bootstrap accordion header margin */
         .accordion-header {
             margin-bottom: 0;
         }
        /* Accordion button (the clickable header) */
        .accordion-button {
             font-weight: 500;
             color: var(--dark-text);
             background-color: var(--accordion-header-bg);
             border-bottom: 1px solid var(--border-color); /* Separator line */
             padding: 1rem 1.25rem;
             width: 100%;
             text-align: left;
             border: none; /* Remove default button border */
        }
         /* Styles for the button when the accordion item is open (not collapsed) */
         .accordion-button:not(.collapsed) {
              color: var(--accordion-active-color);
              background-color: var(--accordion-active-bg);
              box-shadow: inset 0 -1px 0 rgba(0, 0, 0, .125); /* Standard Bootstrap shadow */
              border-bottom-color: var(--accordion-active-bg); /* Hide border when open */
         }
         /* Focus style for accordion button */
         .accordion-button:focus {
              box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25); /* Teal focus ring */
              z-index: 3; /* Ensure focus style is visible */
              outline: none;
         }
         /* Styling for the accordion arrow icon (using Bootstrap's SVG) */
         .accordion-button::after {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%236c757d'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
             flex-shrink: 0;
             width: 1.25rem;
             height: 1.25rem;
             margin-left: auto;
             content: "";
             background-repeat: no-repeat;
             background-size: 1.25rem;
             transition: transform .2s ease-in-out; /* Animate arrow rotation */
         }
         /* Arrow icon style when accordion item is open */
         .accordion-button:not(.collapsed)::after {
              background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23ffffff'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
             transform: rotate(-180deg); /* Rotate arrow upwards */
         }
        /* Accordion body content area */
        .accordion-body {
             background-color: var(--white);
             padding: 1rem 1.25rem;
             font-size: 0.95rem;
             color: var(--muted-text);
        }

        /* --- General Link Styling --- */
        a {
           color: var(--link-color);
           text-decoration: none; /* Remove underline by default */
           transition: color 0.2s ease;
        }
        a:hover {
           color: var(--primary-hover);
           text-decoration: underline; /* Add underline on hover */
        }


        /* --- Print-Specific Styles --- */
         @media print {
             body * {
                 /* Hide everything by default */
                 visibility: hidden !important;
                 margin: 0 !important;
                 padding: 0 !important;
                 box-shadow: none !important;
                 border: none !important;
                 line-height: 1.4; /* Adjust line height for print */
                 font-size: 10pt; /* Set base print font size */
                 color: #000 !important; /* Ensure black text */
                 background: #fff !important; /* Ensure white background */
                 -webkit-print-color-adjust: exact !important; /* Try to force background/color printing */
                 print-color-adjust: exact !important; /* Standard property for compatibility */
                 print-color-adjust: exact !important;
             }

             /* Make only the targeted element and its content visible */
             .print-target, .print-target * {
                 visibility: visible !important;
             }

             /* Ensure the target element takes up the page */
             .print-target {
                 position: absolute !important;
                 left: 20px !important; /* Add some margin */
                 top: 20px !important;
                 right: 20px !important;
                 width: auto !important; /* Allow width to fill */
                 display: block !important; /* Ensure it's a block */
                 border-radius: 0 !important; /* Remove rounded corners for print */
                 background: #fff !important; /* Force white background */
                 padding: 0 !important; /* Reset padding for the main container */
             }

             /* Hide the "Bot:" label and the Export/Print buttons within the target */
             .print-target > b,
             .print-target > .export-invoice-btn,
             .print-target > .print-invoice-btn {
                 display: none !important;
                 visibility: hidden !important;
             }

             /* Style the content span for printing */
             .print-target > span {
                 display: block !important;
                 padding: 0 !important; /* Remove inner padding */
                 margin: 0 !important;
             }

             /* Improve table appearance for print */
              .print-target span table,
              .print-target span th,
              .print-target span td {
                  border: 1px solid #ccc !important; /* Lighter border for print */
                  padding: 4px 6px !important; /* Adjust padding */
                  font-size: 9pt !important;
                  word-wrap: break-word !important; /* Allow text wrapping in cells */
              }
               .print-target span th {
                  background-color: #eee !important; /* Light grey header */
                  font-weight: bold !important;
              }

              /* Ensure links are visible and show URL (optional) */
               .print-target a {
                   color: #000 !important;
                   text-decoration: underline !important;
               }
               /* Optionally show URL after links
               .print-target a[href]:after {
                   content: " (" attr(href) ")";
                   font-size: 8pt;
               } */

              /* Reset other potential visual elements if needed */
               .print-target pre {
                   border: 1px dashed #ccc !important;
                   background: #f9f9f9 !important;
                   padding: 5px !important;
                   white-space: pre-wrap !important; /* Wrap long code lines */
                   word-wrap: break-word !important;
               }
               .print-target blockquote {
                   border-left: 3px solid #ccc !important;
                   padding-left: 10px !important;
                   margin-left: 0 !important;
                   font-style: italic !important;
               }
               .print-target h1, .print-target h2, .print-target h3, .print-target h4, .print-target h5, .print-target h6 {
                    margin-top: 10px !important;
                    margin-bottom: 5px !important;
                    font-weight: bold !important;
               }
                .print-target h3 { font-size: 12pt !important; }
                .print-target h4 { font-size: 11pt !important; }
         }


        /* --- Responsive Adjustments --- */
        /* Medium devices (tablets, 768px and down) */
        @media (max-width: 768px) {
             /* --- UPDATED TABLET DIMENSIONS --- */
             .chat-container {
                 width: calc(100% - 40px); /* Keep responsive width */
                 max-width: 650px; /* Increased max-width for tablets */
                 height: calc(100vh - 80px); /* Use dynamic height */
                 max-height: 700px; /* Optional: slightly larger max-height for tablets */
                 bottom: 90px;
                 right: 20px;
             }
             /* --- END UPDATED TABLET DIMENSIONS --- */

             .hero { padding: 80px 15px; }
             section { padding-top: 40px; padding-bottom: 40px; }
             .feature-card, .how-card { margin-bottom: 20px; } /* Add space between stacked cards */
        }
        /* Small devices (phones, 480px and down) */
        @media (max-width: 480px) {
             /* --- UPDATED PHONE DIMENSIONS (Mainly to match dynamic height approach) --- */
             body { font-size: 0.95rem; } /* Slightly smaller base font */
             .chat-container {
                 width: calc(100% - 20px);
                 right: 10px;
                 bottom: 80px;
                 height: calc(100vh - 90px); /* Keep dynamic height for phones */
             }
             /* --- END UPDATED PHONE DIMENSIONS --- */

             .chat-toggle-btn { width: 60px; height: 60px; bottom: 15px; right: 15px; }
             .hero { padding: 60px 15px; }
             h1.display-4 { font-size: 2.2rem; } /* Smaller hero heading */
             .hero p.lead { font-size: 1rem; } /* Smaller hero lead text */
             .feature-card h4, .how-card h5 { font-size: 1.1rem; } /* Smaller card headings */

             /* Reduce message indentation */
             .you-message { margin-left: 10px; }
             .bot-message {
                 margin-right: 10px;
                 /* --- CORRECTED PADDING (Mobile) --- */
                 padding-right: 95px !important; /* More space for buttons */
                 /* --- END CORRECTED PADDING (Mobile) --- */
             }
             #typingIndicator {
                 margin-right: 10px;
                 padding-right: 15px !important; /* Reset padding for indicator */
             }

             /* Adjust chat footer */
             .chat-footer { padding: 10px 15px; }
             .chat-footer input[type="text"] { padding: 8px 12px; font-size: 0.9rem; }
             .chat-footer .btn-send { width: 38px; height: 38px; }
             .chat-footer .btn-send svg, .chat-footer .btn-send i { width: 16px; height: 16px; }
             /* Adjust chat message padding */
             .chat-body p { padding: 10px 15px; } /* Base padding for mobile */
             /* Ensure bot message padding is overridden */
              .bot-message { padding-right: 95px !important; }
              #typingIndicator { padding-right: 15px !important; }

             /* Adjust accordion padding/font size */
             .accordion-button { font-size: 0.9rem; padding: 0.8rem 1rem; }
             .accordion-body { font-size: 0.9rem; padding: 0.8rem 1rem; }

             /* Adjust export/print buttons on small screens (Corrected Positions) */
             .export-invoice-btn {
                padding: 2px 6px;
                font-size: 0.75em;
                top: 8px;
                 /* --- CORRECTED POSITION (Mobile) --- */
                 right: 55px; /* Adjusted mobile position */
                 /* --- END CORRECTED POSITION (Mobile) --- */
             }
             .print-invoice-btn {
                padding: 2px 6px;
                font-size: 0.75em;
                top: 8px;
                 /* --- CORRECTED POSITION (Mobile) --- */
                 right: 8px; /* Keep at edge */
                 /* --- END CORRECTED POSITION (Mobile) --- */
             }
        }

    </style>
</head>

<body>

    <!-- Hero Section: Introduces the chatbot -->
    <section class="hero">
        <div class="container">
            <img id="logo" src="robot.png" alt="Invoice Bot Icon">
            <h1 class="display-4">Invoice Generator ChatBot</h1>
            <p class="lead">Your AI assistant for creating and managing invoices quickly and professionally.</p>
        </div>
    </section>

    <!-- Features Section: Highlights key benefits -->
    <section class="section-bg">
        <div class="container">
            <h2 class="section-title mb-5">Why Use Invoice Generator ChatBot?</h2>
            <div class="row justify-content-center">
                <!-- Feature 1: Quick Creation -->
                <div class="col-md-3 mb-4">
                     <div class="feature-card">
                         <h4><i class="bi bi-lightning-charge-fill me-2"></i> Quick Creation</h4>
                         <p>Generate invoices in seconds via chat.</p>
                     </div>
                </div>
                <!-- Feature 2: Detail Management -->
                <div class="col-md-3 mb-4">
                     <div class="feature-card">
                         <h4><i class="bi bi-card-list me-2"></i> Detail Input</h4>
                         <p>Easily input client info, items, prices, & terms.</p>
                    </div>
                </div>
                <!-- Feature 3: Export -->
                 <div class="col-md-3 mb-4">
                     <div class="feature-card">
                         <h4><i class="bi bi-download me-2"></i> Export Text</h4>
                         <p>Download the generated invoice as a text file.</p>
                    </div>
                </div>
                <!-- Feature 4: Print -->
                 <div class="col-md-3 mb-4">
                    <div class="feature-card">
                        <h4><i class="bi bi-printer-fill me-2"></i> Print Invoice</h4>
                        <p>Print the formatted invoice directly.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- How It Works Section: Simple steps to use the bot -->
    <section>
        <div class="container">
            <h2 class="section-title mb-5">How It Works</h2>
            <div class="row text-center">
                <!-- Step 1 -->
                <div class="col-md-3 mb-4">
                     <div class="how-card">
                        <h5><span class="badge bg-primary rounded-pill me-2">1</span> Open ChatBot</h5>
                         <p>Click the <i class="bi bi-chat-right-text"></i> button below.</p>
                     </div>
                </div>
                <!-- Step 2 -->
                <div class="col-md-3 mb-4">
                     <div class="how-card">
                        <h5><span class="badge bg-primary rounded-pill me-2">2</span> Provide Details</h5>
                         <p>Tell the bot the client, items, prices, etc. Ask for an example if needed.</p>
                    </div>
                </div>
                <!-- Step 3 -->
                <div class="col-md-3 mb-4">
                     <div class="how-card">
                        <h5><span class="badge bg-primary rounded-pill me-2">3</span> Review Draft</h5>
                         <p>Check the invoice draft generated by the bot.</p>
                    </div>
                </div>
                 <!-- Step 4 -->
                 <div class="col-md-3 mb-4">
                     <div class="how-card">
                        <h5><span class="badge bg-primary rounded-pill me-2">4</span> Export / Print</h5>
                         <p>Use the <i class="bi bi-download"></i> or <i class="bi bi-printer"></i> buttons on the message.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- FAQs Section: Answers common questions using Bootstrap Accordion -->
    <section class="section-bg">
        <div class="container pb-5">
            <h2 class="section-title mb-4">FAQs</h2>
            <div class="accordion" id="faqAccordion">
                <!-- FAQ Item 1 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faqHeading1">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1" aria-expanded="true" aria-controls="faq1">
                            How does this chatbot create invoices?
                        </button>
                    </h2>
                    <div id="faq1" class="accordion-collapse collapse show" aria-labelledby="faqHeading1" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            You provide the details (client, items, prices, etc.) in the chat. The bot uses AI via the OpenRouter API to understand your input, format it into a standard invoice structure using Markdown, and presents it back to you.
                        </div>
                    </div>
                </div>
                 <!-- FAQ Item 2 -->
                 <div class="accordion-item">
                    <h2 class="accordion-header" id="faqHeading2">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2" aria-expanded="false" aria-controls="faq2">
                            Can it actually send the invoice via email?
                        </button>
                    </h2>
                    <div id="faq2" class="accordion-collapse collapse" aria-labelledby="faqHeading2" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            No. This is a frontend demonstration. The chatbot can **simulate** the sending process by confirming it in the chat (e.g., "OK, I've simulated sending..."), but it cannot actually send emails. Use the 'Export' or 'Print' buttons on the invoice message to get the content.
                        </div>
                    </div>
                </div>
                 <!-- FAQ Item 3 -->
                 <div class="accordion-item">
                    <h2 class="accordion-header" id="faqHeading3">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3" aria-expanded="false" aria-controls="faq3">
                            What information do I need to provide?
                        </button>
                    </h2>
                    <div id="faq3" class="accordion-collapse collapse" aria-labelledby="faqHeading3" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Typically: Your company details, Client details (name, address, email if needed), Invoice number, Issue Date, Due Date, Item/Service descriptions, Quantities, Unit Prices, Taxes/Discounts. The bot may ask for missing details. You can also ask the bot "show me an example prompt" for guidance.
                        </div>
                    </div>
                </div>
                 <!-- FAQ Item 4 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faqHeading4">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4" aria-expanded="false" aria-controls="faq4">
                           How do I export or print the invoice?
                        </button>
                    </h2>
                    <div id="faq4" class="accordion-collapse collapse" aria-labelledby="faqHeading4" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                             When the bot generates a message that looks like a complete invoice, small "<i class="bi bi-download"></i> Export" and "<i class="bi bi-printer"></i> Print" buttons will appear in the top-right corner of that message bubble. Click 'Export' to download a text file, or 'Print' to open your browser's print dialog for that specific invoice content.
                        </div>
                    </div>
                </div>
                <!-- FAQ Item 5 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faqHeading5">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq5" aria-expanded="false" aria-controls="faq5">
                           Is my invoice data stored?
                        </button>
                    </h2>
                    <div id="faq5" class="accordion-collapse collapse" aria-labelledby="faqHeading5" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                             This webpage itself does not store your conversation or invoice data after you close it. The information you enter is sent to the OpenRouter API and processed by the AI model according to their privacy policies. Avoid entering extremely sensitive financial details if you have concerns. Exported/printed files are managed by your own computer.
                        </div>
                    </div>
                </div>
                <!-- FAQ Item 6 -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="faqHeading6">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq6" aria-expanded="false" aria-controls="faq6">
                            Why did the bot refuse my request?
                        </button>
                    </h2>
                    <div id="faq6" class="accordion-collapse collapse" aria-labelledby="faqHeading6" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            The bot is specifically programmed to assist with tasks related to generating invoices. It will decline requests outside this scope (e.g., asking for recipes, general knowledge, complex calculations unrelated to invoicing). Please phrase your request clearly around creating or managing an invoice.
                        </div>
                    </div>
                </div>
                 <!-- FAQ Item 7 -->
                 <div class="accordion-item">
                    <h2 class="accordion-header" id="faqHeading7">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq7" aria-expanded="false" aria-controls="faq7">
                            Can I see an example of what to ask the bot?
                        </button>
                    </h2>
                    <div id="faq7" class="accordion-collapse collapse" aria-labelledby="faqHeading7" data-bs-parent="#faqAccordion">
                        <div class="accordion-body">
                            Yes! Just open the chat and ask something like "show me an example prompt" or "what details do you need for an invoice?". The bot will provide a sample template showing the kind of information you can provide.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contact Section: Developer info and contact email -->
    <section class="contact-section">
        <div class="container">
            <h1><b>Developed by:</b></h1>
            <p id="para">Sukhpreet Singh 12307119</p>
            <p id="para">Harshit Guglani 12312754</p>
            <p id="para">Diddukoori Jashwanth 12309771</p>
            <h2 class="mt-4 section-title">Contact Us</h2>
            <p>Have questions or feedback? Reach out to us at <a href="mailto:support@invoicegeneratorbot.com">support@invoicegeneratorbot.com</a></p>
        </div>
    </section>

    <!-- Floating Chatbot Toggle Button -->
    <button class="chat-toggle-btn" onclick="toggleChat()" aria-label="Toggle Chat Window">
        <!-- Bootstrap icon for invoice/document -->
        <i class="bi bi-file-earmark-text-fill"></i>
    </button>

    <!-- Chatbot Window Container -->
    <div class="chat-container" id="chatbox">
        <!-- Chat Header: Title and Close Button, Draggable Handle -->
        <div class="chat-header" id="chatHeader">
            <span>Invoice Generator Bot</span>
            <span class="chat-close" onclick="toggleChat()" aria-label="Close Chat Window">✕</span>
        </div>
        <!-- Chat Body: Displays messages -->
        <div class="chat-body" id="response">
             <!-- Initial welcome message from the bot -->
             <p class="bot-message"><b>Bot:</b> <span class="initial-msg-content">Hi! 👋🏻 I'm the Invoice Generator Bot. Tell me the details for the invoice you want to create (client name, items, amounts, etc.), and I'll help draft it. You can also ask me to simulate sending it or ask for an example prompt.</span></p> <!-- Updated initial msg -->
             <!-- Typing indicator will be dynamically added here -->
        </div>
        <!-- Chat Footer: User input field and send button -->
        <div class="chat-footer">
            <input type="text" class="form-control" id="userInput" placeholder="Enter invoice details, 'send', or ask for an example..." aria-label="User input for chatbot"> <!-- Updated placeholder -->
            <button class="btn btn-primary btn-send" onclick="sendMessage()" aria-label="Send message">
                 <!-- Bootstrap send icon -->
                 <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>

    <!-- Bootstrap 5 Bundle JS (includes Popper.js for tooltips, popovers, dropdowns, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- DOM Element References ---
        const chatbox = document.getElementById("chatbox");
        const chatHeader = document.getElementById("chatHeader");
        const responseDiv = document.getElementById('response');
        const userInput = document.getElementById('userInput');
        const toggleButton = document.querySelector('.chat-toggle-btn');
        const chatBody = document.querySelector('.chat-body');

        // --- CONFIGURATION ---
        // IMPORTANT: Replace 'YOUR_OPENROUTER_API_KEY_HERE' with your actual OpenRouter API key.
        // Get a key from https://openrouter.ai/
        // *** PASTE YOUR ACTUAL KEY HERE ***
        const apiBearerToken = 'API_KEY'; // <-- ENTER KEY (Replace!)
        const siteUrl = 'https://your-invoice-website.com'; // Optional: Helps OpenRouter identify usage
        const siteName = 'Invoice Generator ChatBot Page'; // Optional: Helps OpenRouter identify usage
        const modelIdentifier = "google/gemini-2.0-flash-lite-001"; // Example model

        // --- INVOICE-SPECIFIC RELEVANCE FILTER ---
        const relevantKeywords = [
            "invoice", "bill", "client", "customer", "item", "product", "service", "description",
            "quantity", "qty", "price", "cost", "rate", "amount", "total", "subtotal", "tax", "vat",
            "discount", "due date", "payment terms", "send", "email", "generate", "create", "draft",
            "add item", "company details", "address", "invoice number", "issue date", "iban", "swift", "bank"
        ];

        // --- SYSTEM PROMPT FOR INVOICE GENERATION ---
        const systemPrompt = `You are 'Invoice Generator Bot', an AI assistant specialized **ONLY** in helping users create and manage invoices. Your primary functions are:
1.  **Gather Invoice Details:** Interact conversationally to collect necessary invoice information: Your details (if not previously provided), Client details (Name, Address, Email if needed for simulation), Invoice #, Dates (Issue, Due), Line Items (Description, Quantity, Unit Price), Taxes (percentage or amount), Discounts (percentage or amount), Payment Terms, optional Notes. Ask clarifying questions for missing essential details (like client name, items, total).
2.  **Format Invoice:** Once sufficient details are gathered, format the information clearly into a professional-looking invoice structure using Markdown. Use headings for sections (Your Info, Client Info, Items, Summary), a table for line items (Description | Qty | Unit Price | Amount), and bold text for labels and totals. Calculate line item totals and the final total amount. Format amounts clearly (e.g., $1,234.56).
3.  **Simulate Sending:** If the user asks to "send" the invoice (or similar phrasing like "email it"), acknowledge the request and confirm the *simulation* of sending (e.g., "OK, I have simulated sending the invoice draft to [Client Name/Email if provided]."). **DO NOT** imply you can actually send emails or connect to services. Mention they can use the 'Export' or 'Print' buttons if available.
4.  **Refuse Off-Topic Requests:** You **MUST REFUSE** any question or task outside the scope of invoice generation/management. If asked about unrelated topics (weather, recipes, general knowledge, coding, personal opinions, complex math not for the invoice), politely state your specialization in invoices and decline. Example refusal: "I specialize in helping with invoices. I can't assist with [user's off-topic request]. How can I help with your invoice?" Do **NOT** answer off-topic questions.

**CRITICAL:** Always use Markdown for invoice formatting, especially tables for line items. Be friendly and conversational while gathering info. Clearly state sending is a simulation. Strictly adhere to the invoice-only role. Calculate totals correctly. Do **NOT** handle requests for examples or templates yourself; the application code handles those directly.`;

        // --- SAMPLE PROMPT TEXT ---
        const sampleInvoicePrompt = `
Okay, here's an example of the kind of detailed prompt you can give me to generate an invoice:

\`\`\`text
Generate a complete invoice with the following details:

My Information:
Visionary Media Lab
200 Innovation Way
Creatorsville, WA 98001
email: contact@visionarymedia.co

Client Information:
Green Earth Landscaping
145 Garden Grove Rd
Bloomtown, OR 97211

Invoice Number: GEL-2024-017
Issue Date: March 15, 2024
Due Date: April 15, 2024

Items:
- Social Media Strategy Session, Quantity: 1 session, Unit Price: $300
- Promotional Video Editing, Quantity: 10 hours, Unit Price: $85 per hour

Discount: Apply a $100 discount (reason: referral bonus)
Tax: No tax should be applied (0%)
Payment Terms: Net 30 – payment due within 30 days of issue date
Payment Notes: Please include this note: *Payable via ACH transfer to Visionary Media Lab (Routing #123456789, Account #987654321) or by check mailed to 200 Innovation Way, Creatorsville, WA 98001*
\`\`\`

Just provide similar details for your own invoice, and I'll do my best to format it for you!
`;

        // --- HELPER FUNCTIONS ---

        /**
         * Checks if the user input is likely asking for an example invoice prompt.
         */
        function isAskingForExamplePrompt(query) {
            const lowerCaseQuery = query.toLowerCase().trim();
            const asksForExample = /\b(example|sample|show me|give me an?|template|format|structure|what details|what info)\b/.test(lowerCaseQuery);
            const mentionsTarget = /\b(invoice|bill|prompt|details?|needed|required)\b/.test(lowerCaseQuery);
            return (asksForExample && mentionsTarget) || /what\s+(details|info|information)\s+(do you need|are needed|is required)/.test(lowerCaseQuery);
        }

        /**
         * Checks if a string likely contains Markdown representing an invoice.
         */
        function isLikelyInvoice(text) {
            if (!text) return false;
            const lowerText = text.toLowerCase();
            const hasInvoiceHeading = /#{1,4}\s*invoice/i.test(text);
            const hasItemsTable = /\|\s*description\s*\|.*\|\s*amount\s*\|/i.test(lowerText);
            const hasTotal = /\*\*\s*total[:]?\s*\*\*/i.test(lowerText) || /grand total/i.test(lowerText) || /amount due/i.test(lowerText);
            const hasDueDate = /due date/i.test(lowerText);
            const hasClientInfo = /client\s*(information|details|:)/i.test(lowerText);
            const hasYourInfo = /(your|company|from)\s*(information|details|:)/i.test(lowerText);
            return (hasInvoiceHeading || (hasClientInfo && hasYourInfo)) && hasItemsTable && hasTotal && hasDueDate;
        }

        /**
         * Attempts to extract an invoice number from the text for the filename.
         */
        function extractInvoiceNumber(text) {
            if (!text) return null;
            const match = text.match(/Invoice\s*(Number|Num|#)?\s*[:\-#]?\s*([a-z0-9\-_\.]+)/i);
            if (match && match[2]) {
                return match[2].replace(/[.,;:]$/, '').trim();
            }
             const earlyMatch = text.substring(0, 200).match(/([A-Z]{2,5}-?\d{4,}-?\d{2,})/i);
             if (earlyMatch && earlyMatch[1]) {
                 return earlyMatch[1].trim();
             }
            return null;
        }

        /**
         * Triggers the download of provided text content as a file.
         */
        function exportInvoiceText(textContent, filename = 'invoice-export.txt') {
            if (!textContent) return;
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * Prepares the specific invoice message for printing and triggers the print dialog.
         */
        function printInvoiceContent(messageElement) {
            if (!messageElement) return;

            const currentlyPrinting = document.querySelector('.print-target');
            if (currentlyPrinting) {
                currentlyPrinting.classList.remove('print-target');
            }

            messageElement.classList.add('print-target');

            const cleanup = () => {
                messageElement.classList.remove('print-target');
                window.removeEventListener('afterprint', cleanup); // Ensure listener is removed
            };

            // Use a flag to prevent multiple cleanup calls with setTimeout fallback
            let cleanupCalled = false;
            const cleanupOnce = () => {
                if (!cleanupCalled) {
                    cleanup();
                    cleanupCalled = true;
                }
            };

            if ('onafterprint' in window) {
                // Use try...finally to ensure cleanup happens even if user cancels print
                 try {
                     window.addEventListener('afterprint', cleanupOnce, { once: true });
                 } finally {
                      // Add a slight delay for style application before printing
                      setTimeout(() => {
                          window.print();
                           // Extra fallback timeout in case afterprint doesn't fire
                           setTimeout(cleanupOnce, 500);
                      }, 50);
                 }
            } else {
                 // Fallback for browsers without reliable onafterprint
                 setTimeout(() => {
                     window.print();
                     setTimeout(cleanupOnce, 1000); // Longer fallback cleanup
                 }, 50);
            }
        }


        /**
         * Toggles the visibility of the chat window and the toggle button.
         */
        function toggleChat() {
            const chatIsOpen = chatbox.style.display === "flex";
            if (chatIsOpen) {
                chatbox.style.display = "none";
                toggleButton.style.opacity = "1";
                toggleButton.style.visibility = "visible";
            } else {
                chatbox.style.display = "flex";
                toggleButton.style.opacity = "0";
                toggleButton.style.visibility = "hidden";
                setTimeout(() => {
                    if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;
                    if (userInput) userInput.focus();
                }, 50);
            }
        }

        /**
         * Appends a message to the chat body, adding export/print buttons if it's an invoice.
         */
        function appendMessage(sender, message, isHtml = false) {
            const messageElement = document.createElement("p");
            const senderClass = sender.toLowerCase().replace(/\s+/g, '-');
            messageElement.classList.add(senderClass + '-message');

            const labelElement = document.createElement('b');
            labelElement.textContent = `${sender}:`;
            messageElement.appendChild(labelElement);

            const contentWrapper = document.createElement('span');
            if (sender === 'Bot' && (message.includes("Hi! 👋🏻") || message.includes("example prompt"))) {
                contentWrapper.classList.add('initial-msg-content');
            }

            // --- EXPORT/PRINT BUTTON LOGIC ---
            let rawBotMessage = '';
            if (sender === 'Bot') {
                 rawBotMessage = message;
                 // Store raw markdown in a data attribute for potential use in history
                 messageElement.dataset.rawMarkdown = rawBotMessage;

                 if (isLikelyInvoice(rawBotMessage)) {
                     // Export Button
                     const exportButton = document.createElement('button');
                     exportButton.classList.add('export-invoice-btn');
                     exportButton.setAttribute('aria-label', 'Export Invoice Text');
                     exportButton.innerHTML = '<i class="bi bi-download"></i> Export';
                     const invoiceNumber = extractInvoiceNumber(rawBotMessage);
                     const filename = invoiceNumber ? `invoice-${invoiceNumber}.txt` : 'invoice-export.txt';
                     exportButton.onclick = (event) => {
                         event.stopPropagation();
                         exportInvoiceText(rawBotMessage, filename);
                     };
                     messageElement.appendChild(exportButton);

                     // Print Button
                     const printButton = document.createElement('button');
                     printButton.classList.add('print-invoice-btn');
                     printButton.setAttribute('aria-label', 'Print Invoice');
                     printButton.innerHTML = '<i class="bi bi-printer"></i> Print';
                     printButton.onclick = (event) => {
                         event.stopPropagation();
                         printInvoiceContent(messageElement); // Pass the <p> element
                     };
                     messageElement.appendChild(printButton);
                 }
            }
            // --- END EXPORT/PRINT BUTTON LOGIC ---

            if (isHtml) {
                try {
                    const messageToRender = rawBotMessage || message;
                    const renderedHtml = marked.parse(messageToRender, { breaks: true, gfm: true, pedantic: false, smartypants: false });
                    contentWrapper.innerHTML = renderedHtml;
                } catch (e) {
                     console.error("Markdown parsing error:", e);
                     contentWrapper.textContent = message; // Fallback
                }
            } else {
                contentWrapper.textContent = message;
            }
             messageElement.appendChild(contentWrapper); // Add the content span

            responseDiv.appendChild(messageElement); // Add the complete message paragraph

             // Scroll to bottom
             requestAnimationFrame(() => {
                 if (chatBody) chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: 'smooth' });
             });
        }

        /**
         * Displays the typing indicator.
         */
        function showTypingIndicator() {
            hideTypingIndicator();
            const typingIndicator = document.createElement("p");
            typingIndicator.id = "typingIndicator";
            typingIndicator.classList.add('bot-message');
             // Reset padding specifically for typing indicator
             typingIndicator.style.paddingRight = '18px';
            typingIndicator.innerHTML = `<b>Bot:</b> <span class="typing-indicator"><span></span><span></span><span></span></span>`;
            responseDiv.appendChild(typingIndicator);
            requestAnimationFrame(() => {
                if (chatBody) chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: 'smooth' });
            });
        }

        /**
         * Removes the typing indicator.
         */
        function hideTypingIndicator() {
            const indicator = document.getElementById("typingIndicator");
            if (indicator) indicator.remove();
        }

        /**
         * Checks if the user's query seems relevant to invoice generation (excluding example requests).
         */
        function isQueryRelevant(query) {
            const lowerCaseQuery = query.toLowerCase();
            const containsKeyword = relevantKeywords.some(keyword => lowerCaseQuery.includes(keyword));
            const looksLikeData = /(\d+)\s*(x|\*)\s*[$€£]?\d+(\.\d+)?/.test(lowerCaseQuery) || /client:/i.test(lowerCaseQuery) || /item:/i.test(lowerCaseQuery) || /due by/i.test(lowerCaseQuery) || /inv-?#?\s?\d+/i.test(lowerCaseQuery);
            return containsKeyword || looksLikeData;
        }

        /**
         * Sends the user's message: handles API key check, example request,
         * relevance check, API call, and response display.
         */
        async function sendMessage() {
            const input = userInput.value.trim();
            if (!input) return;

            // API Key Check
             if (!apiBearerToken || apiBearerToken === 'YOUR_OPENROUTER_API_KEY_HERE' || apiBearerToken.length < 50) {
                 const errorHtml = `<span style="color: orange; font-weight: bold;"><i class="bi bi-exclamation-triangle-fill me-2"></i>SETUP NEEDED:</span> Please add a valid OpenRouter API key in the script section.`;
                 appendMessage("Bot", errorHtml, true);
                 userInput.value = "";
                 return;
            }

            userInput.value = "";
            appendMessage("You", input); // Show user message first

            // Check for Example Request
            if (isAskingForExamplePrompt(input)) {
                console.log("User asking for example prompt:", input);
                setTimeout(() => {
                    appendMessage("Bot", sampleInvoicePrompt, true); // Show predefined example
                    if (userInput) userInput.focus();
                }, 300);
                return; // Handled, stop here
            }

            // Relevance Check (Only if not an example request)
            if (!isQueryRelevant(input)) {
                console.log("Query deemed irrelevant:", input);
                const refusalMessage = "My apologies, I specialize only in creating and managing invoices. I can't help with unrelated topics. How can I assist with your invoice?";
                setTimeout(() => {
                    appendMessage("Bot", refusalMessage);
                    if (userInput) userInput.focus();
                }, 300);
                return; // Not relevant, stop here
            }

            // Proceed to API if relevant and not an example request
            console.log("Query relevant, sending to AI:", input);
            showTypingIndicator();

            // Build Conversation History
            const messages = [{ "role": "system", "content": systemPrompt }];
            const chatHistory = responseDiv.querySelectorAll('p:not(#typingIndicator)');
            chatHistory.forEach(p => {
                const labelElement = p.querySelector('b');
                if (!labelElement) return;
                const sender = labelElement.textContent.replace(':', '').trim();
                const contentWrapper = p.querySelector('span');
                let content = '';
                if (contentWrapper) {
                     // const hasExportButton = p.querySelector('.export-invoice-btn'); // Less reliable
                     const isSamplePromptMsg = contentWrapper.textContent.includes("here's an example of the kind of detailed prompt");
                     const rawMarkdown = p.dataset.rawMarkdown; // Get raw markdown if stored

                     if (sender === 'Bot' && rawMarkdown && isLikelyInvoice(rawMarkdown)) {
                         // If it was likely an invoice and we have raw markdown, send that
                         content = rawMarkdown;
                     } else if (sender === 'Bot' && isSamplePromptMsg) {
                         content = "[User was shown sample prompt]"; // Avoid sending full sample
                     } else if (sender === 'Bot') {
                         content = contentWrapper.innerHTML.trim(); // Send rendered HTML for other bot messages
                     } else { // User message
                         content = contentWrapper.textContent.trim();
                     }
                 } else {
                    content = p.textContent.substring(p.textContent.indexOf(':') + 1).trim(); // Basic fallback
                }

                 if (sender === 'You' && content) {
                    messages.push({ "role": "user", "content": content });
                } else if (sender === 'Bot' && content && !content.includes('SETUP NEEDED') && content !== "[User was shown sample prompt]") {
                    messages.push({ "role": "assistant", "content": content });
                }
            });
            messages.push({ "role": "user", "content": input });
            // console.log("Sending messages:", JSON.stringify(messages, null, 2));


            // API Call
            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiBearerToken}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': siteUrl,
                        'X-Title': siteName
                    },
                    body: JSON.stringify({
                        "model": modelIdentifier,
                        "messages": messages,
                        "temperature": 0.6,
                        "max_tokens": 1500,
                    }),
                });

                hideTypingIndicator();

                // Handle API Response
                if (!response.ok) {
                    let errorDetails = `HTTP Error: ${response.status} ${response.statusText}`;
                    try {
                         const errorData = await response.json();
                         console.error("API Error Response:", errorData);
                         errorDetails += ` - ${errorData.error?.message || 'No details.'}`;
                         if(response.status === 401) errorDetails += " (Check API Key)";
                         if(response.status === 402) errorDetails += " (Check Credits)";
                         if(response.status === 429) errorDetails += " (Rate Limited)";
                         if(response.status >= 500) errorDetails += " (Server Error)";
                    } catch (e) { /* Ignore */ }
                     const errorHtml = `<span style="color: red; font-weight: bold;"><i class="bi bi-x-octagon-fill me-2"></i>API Error:</span> ${errorDetails}`;
                     appendMessage("Bot", errorHtml, true);
                    return;
                }

                const data = await response.json();
                console.log("API Success Response:", data);
                const botResponse = data.choices?.[0]?.message?.content;

                if (botResponse) {
                    // Append the AI's response, rendering Markdown & checking for export/print buttons
                    appendMessage("Bot", botResponse.trim(), true);
                } else {
                     console.error("Empty or malformed response content:", data);
                     appendMessage("Bot", "Sorry, I received an unexpected response. Try rephrasing?");
                }

            } catch (error) {
                hideTypingIndicator();
                console.error("Network/Fetch Error:", error);
                 const errorHtml = `<span style="color: red; font-weight: bold;"><i class="bi bi-wifi-off me-2"></i>Network Error:</span> ${error.message}. Check connection.`;
                 appendMessage("Bot", errorHtml, true);
            } finally {
                 if (userInput) userInput.focus();
            }
        } // End of sendMessage function

        // --- EVENT LISTENERS ---
        if (userInput) {
            userInput.addEventListener('keypress', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
        }

        // --- INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', (event) => {
             if (chatbox) chatbox.style.display = "none";
             if (chatbox && chatHeader) makeDraggable(chatbox, chatHeader);

             // Pre-render the initial bot message
             const initialBotMsgContent = responseDiv.querySelector('.initial-msg-content');
             if (initialBotMsgContent) {
                 try {
                     const initialHtml = marked.parse(initialBotMsgContent.textContent || '', { breaks: true, gfm: true });
                     initialBotMsgContent.innerHTML = initialHtml;
                 } catch (e) {
                     console.error("Error parsing initial message markdown:", e);
                 }
             }
        });


        // --- DRAGGING FUNCTIONALITY ---
         function makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            let isDragging = false;
             const dragHandle = handle || element;

             dragHandle.onmousedown = dragMouseDown;
             dragHandle.ontouchstart = dragMouseDown;

            function dragMouseDown(e) {
                 if (e.type === 'mousedown' && e.button !== 0) return;
                 if (e.type === 'mousedown') e.preventDefault();

                 if (e.type === 'touchstart') {
                     pos3 = e.touches[0].clientX;
                     pos4 = e.touches[0].clientY;
                 } else {
                     pos3 = e.clientX;
                     pos4 = e.clientY;
                 }

                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                 document.ontouchend = closeDragElement;
                 document.ontouchmove = elementDrag;

                isDragging = true;
                element.style.transition = 'none';
                 dragHandle.style.cursor = 'grabbing';
                 document.body.style.userSelect = 'none';
            }

            function elementDrag(e) {
                if (!isDragging) return;
                 e.preventDefault();

                 let currentX, currentY;
                 if (e.type === 'touchmove') {
                     currentX = e.touches[0].clientX;
                     currentY = e.touches[0].clientY;
                 } else {
                     currentX = e.clientX;
                     currentY = e.clientY;
                 }

                pos1 = pos3 - currentX;
                pos2 = pos4 - currentY;
                pos3 = currentX;
                pos4 = currentY;

                let newTop = element.offsetTop - pos2;
                let newLeft = element.offsetLeft - pos1;

                const maxTop = window.innerHeight - element.offsetHeight;
                const maxLeft = window.innerWidth - element.offsetWidth;
                 newTop = Math.max(0, Math.min(newTop, maxTop));
                 newLeft = Math.max(0, Math.min(newLeft, maxLeft));

                element.style.top = newTop + "px";
                element.style.left = newLeft + "px";
                 element.style.bottom = 'auto';
                 element.style.right = 'auto';
            }

            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
                 document.ontouchend = null;
                 document.ontouchmove = null;

                isDragging = false;
                 element.style.transition = '';
                 dragHandle.style.cursor = 'grab';
                 document.body.style.userSelect = '';
            }
        } // End of makeDraggable

    </script>

</body>
</html>
